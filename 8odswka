local Library = {}
Library.__index = Library

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

-- Helper function to create a new instance
local function createInstance(className, properties)
    local instance = Instance.new(className)
    for prop, value in pairs(properties) do
        instance[prop] = value
    end
    return instance
end

-- Initialize UI
function Library:Init(title)
    local screenGui = Instance.new("ScreenGui")
    screenGui.Parent = RunService:IsStudio() and Players.LocalPlayer:WaitForChild("PlayerGui") or CoreGui

    self.Window = createInstance("Frame", {
        Size = UDim2.new(0, 200, 0, 180),
        BackgroundColor3 = Color3.fromRGB(30, 30, 30),
        Position = UDim2.new(0, 100, 0, 100),
        BorderSizePixel = 0,
        Parent = screenGui
    })

    local titleLabel = createInstance("TextLabel", {
        Size = UDim2.new(1, 0, 0, 30),
        BackgroundColor3 = Color3.fromRGB(0, 102, 204),
        TextColor3 = Color3.fromRGB(255, 255, 255),
        Text = title,
        TextScaled = true,
        BorderSizePixel = 0,
        Parent = self.Window
    })

    -- Create a UIListLayout to handle the layout of sections
    self.Layout = createInstance("UIListLayout", {
        Padding = UDim.new(0, 10),
        SortOrder = Enum.SortOrder.LayoutOrder,
        Parent = self.Window
    })

    self.Sections = {}
end

-- Create a new Section
function Library:CreateSection(title)
    local section = createInstance("Frame", {
        Size = UDim2.new(1, 0, 0, 120),
        BackgroundColor3 = Color3.fromRGB(40, 40, 40),
        BorderSizePixel = 0,
        LayoutOrder = #self.Sections + 1, -- Ensure sections are ordered
        Parent = self.Window
    })

    local sectionTitle = createInstance("TextLabel", {
        Size = UDim2.new(1, 0, 0, 30),
        BackgroundColor3 = Color3.fromRGB(0, 102, 204),
        TextColor3 = Color3.fromRGB(255, 255, 255),
        Text = title,
        TextScaled = true,
        BorderSizePixel = 0,
        Parent = section
    })

    local layout = createInstance("UIListLayout", {
        Padding = UDim.new(0, 6),
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Parent = section
    })

    table.insert(self.Sections, section)

    return {
        CreateButton = function(self, text, onClick)
            local button = createInstance("TextButton", {
                Size = UDim2.new(1, -20, 0, 30),
                BackgroundColor3 = Color3.fromRGB(0, 102, 204),
                TextColor3 = Color3.fromRGB(255, 255, 255),
                Text = text,
                TextScaled = true,
                LayoutOrder = #section:GetChildren() + 1, -- Ensure buttons are ordered within the section
                Parent = section
            })
            button.MouseButton1Click:Connect(onClick)
            return button
        end,

        CreateToggle = function(self, text, onToggle)
            local frame = createInstance("Frame", {
                Size = UDim2.new(1, -20, 0, 50),
                BackgroundColor3 = Color3.fromRGB(255, 255, 255),
                LayoutOrder = #section:GetChildren() + 1, -- Ensure toggles are ordered within the section
                Parent = section
            })

            local label = createInstance("TextLabel", {
                Size = UDim2.new(1, 0, 0, 30),
                BackgroundColor3 = Color3.fromRGB(255, 255, 255),
                TextColor3 = Color3.fromRGB(0, 0, 0),
                Text = text,
                TextScaled = true,
                Parent = frame
            })

            local switch = createInstance("TextButton", {
                Size = UDim2.new(0.5, 0, 1, 0),
                Position = UDim2.new(0.5, 0, 0, 0),
                BackgroundColor3 = Color3.fromRGB(0, 102, 204),
                TextColor3 = Color3.fromRGB(255, 255, 255),
                Text = "",
                TextScaled = true,
                Parent = frame
            })

            local toggled = false
            switch.MouseButton1Click:Connect(function()
                toggled = not toggled
                switch.BackgroundColor3 = toggled and Color3.fromRGB(0, 204, 102) or Color3.fromRGB(0, 102, 204)
                switch.Text = toggled and "ON" or "OFF"
                onToggle(toggled)
            end)

            return frame
        end
    }
end

return Library
